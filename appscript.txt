// ===== HÀM CHÍNH - XỬ LÝ REQUEST TỪ REACT =====
function doPost(e) {
  try {
    Logger.log('Received request');
    Logger.log('Full event: ' + JSON.stringify(e));
    
    var data;
    
    // Thử lấy từ parameter (khi gửi FormData)
    if (e && e.parameter && e.parameter.data) {
      Logger.log('Getting data from parameter');
      data = JSON.parse(e.parameter.data);
    }
    // Thử lấy từ postData (khi gửi JSON)
    else if (e && e.postData && e.postData.contents) {
      Logger.log('Getting data from postData');
      data = JSON.parse(e.postData.contents);
    }
    // Không tìm thấy data
    else {
      Logger.log('No data found in request');
      return ContentService.createTextOutput(JSON.stringify({
        'result': 'error',
        'error': 'No data received',
        'debug': JSON.stringify(e)
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    Logger.log('Parsed data: ' + JSON.stringify(data));
    
    // Lấy sheet
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Sheet1');
    if (!sheet) {
      Logger.log('Sheet1 not found, using first sheet');
      sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
    }
    
    Logger.log('Sheet name: ' + sheet.getName());
    
    // Ghi vào sheet
    sheet.appendRow([
      data.Timestamp,
      data.name,
      data.email,
      data.message
    ]);
    
    Logger.log('Added to sheet successfully');
    
    // Gửi email
    sendEmailNotification(data);
    
    Logger.log('Email sent successfully');
    
    return ContentService.createTextOutput(JSON.stringify({
      'result': 'success',
      'message': 'Contact saved and emails sent'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch(error) {
    Logger.log('Error occurred: ' + error.toString());
    Logger.log('Error stack: ' + error.stack);
    return ContentService.createTextOutput(JSON.stringify({
      'result': 'error',
      'error': error.toString(),
      'stack': error.stack
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ===== GỬI EMAIL THÔNG BÁO CHO ADMIN =====
function sendEmailNotification(data) {

  var recipientEmail = 'lehuuhoanganhhg2003@gmail.com';
  
  var subject = 'Có liên hệ mới từ website - ' + data.name;
  
  var htmlBody = '<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">' +
    '<h2 style="color: #4CAF50;">Thông Báo Liên Hệ Mới</h2>' +
    '<div style="background-color: #f5f5f5; padding: 20px; border-radius: 5px;">' +
    '<p><strong>Thời gian:</strong> ' + data.Timestamp + '</p>' +
    '<p><strong>Tên:</strong> ' + data.name + '</p>' +
    '<p><strong>Email:</strong> <a href="mailto:' + data.email + '">' + data.email + '</a></p>' +
    '<p><strong>Tin nhắn:</strong></p>' +
    '<div style="background-color: white; padding: 15px; border-left: 4px solid #4CAF50;">' +
    data.message +
    '</div>' +
    '</div>' +
    '<p style="color: #888; font-size: 12px; margin-top: 20px;">' +
    'Email này được gửi tự động từ hệ thống liên hệ website.' +
    '</p>' +
    '</div>';
  
  MailApp.sendEmail({
    to: recipientEmail,
    subject: subject,
    htmlBody: htmlBody
  });
  
  // Gửi email xác nhận cho người liên hệ
  sendConfirmationEmail(data);
}

// ===== GỬI EMAIL XÁC NHẬN CHO NGƯỜI LIÊN HỆ =====
function sendConfirmationEmail(data) {
  var subject = 'Cảm ơn bạn đã liên hệ với chúng tôi';
  
  var htmlBody = '<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">' +
    '<h2 style="color: #4CAF50;">Xin chào ' + data.name + '!</h2>' +
    '<p>Cảm ơn bạn đã liên hệ với chúng tôi. Chúng tôi đã nhận được tin nhắn của bạn:</p>' +
    '<div style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0;">' +
    '<em>"' + data.message + '"</em>' +
    '</div>' +
    '<p>Chúng tôi sẽ phản hồi bạn trong thời gian sớm nhất.</p>' +
    '<p>Trân trọng,<br>Đội ngũ hỗ trợ</p>' +
    '</div>';
  
  MailApp.sendEmail({
    to: data.email,
    subject: subject,
    htmlBody: htmlBody
  });
}

// ===== CÁC HÀM TEST =====

// Test 1: Chỉ test gửi email
function testEmail() {
  var testData = {
    Timestamp: '02/12/2025 10:30:00',
    name: 'Nguyễn Văn B',
    email: 'anhb2105599@student.ctu.edu.vn',
    message: 'Đây là tin nhắn test KK'
  };
  
  Logger.log('Testing email...');
  sendEmailNotification(testData);
  Logger.log('Check your email!');
}

// Test 2: Chỉ test ghi vào Sheet
function testWriteSheet() {
  try {
    Logger.log('Testing write to sheet...');
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Sheet1');
    
    if (!sheet) {
      Logger.log('Sheet1 not found, using first sheet');
      sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
    }
    
    Logger.log('Sheet name: ' + sheet.getName());
    
    var testData = {
      Timestamp: new Date().toLocaleString('vi-VN'),
      name: 'Test User',
      email: 'anhb2105599@student.ctu.edu.vn',
      message: 'Test message'
    };
    
    sheet.appendRow([
      testData.Timestamp,
      testData.name,
      testData.email,
      testData.message
    ]);
    
    Logger.log('✓ Write successful!');
    Logger.log('Check your sheet now');
    
  } catch(error) {
    Logger.log('✗ Error: ' + error.toString());
  }
}

// Test 3: Test toàn bộ function doPost
function testDoPostWithMockData() {
  Logger.log('Testing doPost with mock event...');
  
  // Tạo mock event giống như React gửi lên
  var mockEvent = {
    postData: {
      contents: JSON.stringify({
        Timestamp: new Date().toLocaleString('vi-VN'),
        name: 'Mock Test User',
        email: 'anhb2105599@student.ctu.edu.vn',
        message: 'This is a test message from mock event'
      }),
      type: 'application/json'
    }
  };
  
  Logger.log('Mock event created');
  
  // Gọi doPost với mock event
  var result = doPost(mockEvent);
  
  Logger.log('Result: ' + result.getContent());
  Logger.log('Check Sheet and Email now!');
}

// Test 4: Test toàn bộ chức năng (Sheet + Email)
function testFullFunction() {
  Logger.log('=== TESTING FULL FUNCTION ===');
  
  var testData = {
    Timestamp: new Date().toLocaleString('vi-VN'),
    name: 'Full Test User',
    email: 'anhb2105599@student.ctu.edu.vn',
    message: 'Testing full contact form functionality'
  };
  
  try {
    // Test ghi Sheet
    Logger.log('1. Testing Sheet...');
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Sheet1');
    if (!sheet) {
      sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
    }
    
    sheet.appendRow([
      testData.Timestamp,
      testData.name,
      testData.email,
      testData.message
    ]);
    Logger.log('✓ Sheet OK');
    
    // Test gửi email
    Logger.log('2. Testing Email...');
    sendEmailNotification(testData);
    Logger.log('✓ Email OK');
    
    Logger.log('=== ALL TESTS PASSED ===');
    Logger.log('Check your Sheet and Email now!');
    
  } catch(error) {
    Logger.log('✗ ERROR: ' + error.toString());
  }
}